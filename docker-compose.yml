version: '3.8'

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: telegram-buddy
    restart: unless-stopped
    volumes:
      # Persist the SQLite database
      - ./data/db:/app/data/db
      # Persist the tmp directory for voice processing
      - ./data/tmp:/app/tmp
    environment:
      # Define environment variables directly in docker-compose
      - TELEGRAM_TOKEN=${TELEGRAM_TOKEN}
      - AUTHORIZED_USERNAME=${AUTHORIZED_USERNAME}
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
      - NODE_ENV=production
      # Add any other environment variables your application needs
    command: >
      sh -c "
        mkdir -p /app/data/db;

        if [ -f /app/tasks.sqlite ]; then
          mv /app/tasks.sqlite /app/data/db/tasks.sqlite;
        fi;

        ln -sf /app/data/db/tasks.sqlite /app/tasks.sqlite;

        echo \"# Generated .env file - DO NOT EDIT MANUALLY\" > /app/.env;
        echo \"TELEGRAM_TOKEN=${TELEGRAM_TOKEN}\" >> /app/.env;
        echo \"AUTHORIZED_USERNAME=${AUTHORIZED_USERNAME}\" >> /app/.env;
        echo \"DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}\" >> /app/.env;
        echo \"NODE_ENV=${NODE_ENV}\" >> /app/.env;

        npm start;
      "
