version: '3.8'

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: telegram-buddy
    restart: unless-stopped
    volumes:
      # Persist the SQLite database
      - ./data/db:/app/data/db
      # Persist the tmp directory for voice processing
      - ./data/tmp:/app/tmp
    environment:
      # Define environment variables directly in docker-compose
      - TELEGRAM_TOKEN=${TELEGRAM_TOKEN}
      - AUTHORIZED_USERNAME=${AUTHORIZED_USERNAME}
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
      - NODE_ENV=production
      # Add any other environment variables your application needs
    command: >
      sh -c "
        # Create data directories if they don't exist
        mkdir -p /app/data/db

        # Move SQLite database to volume if it exists in root
        if [ -f /app/tasks.sqlite ]; then
          mv /app/tasks.sqlite /app/data/db/tasks.sqlite
        fi

        # Create symlink to maintain compatibility with existing code
        ln -sf /app/data/db/tasks.sqlite /app/tasks.sqlite

        # Create .env file from environment variables
        echo \"# Generated .env file - DO NOT EDIT MANUALLY\" > /app/.env
        echo \"# This file is automatically generated from docker-compose environment variables\" >> /app/.env
        echo \"TELEGRAM_TOKEN=\${TELEGRAM_TOKEN}\" >> /app/.env
        echo \"AUTHORIZED_USERNAME=\${AUTHORIZED_USERNAME}\" >> /app/.env
        echo \"DEEPSEEK_API_KEY=\${DEEPSEEK_API_KEY}\" >> /app/.env
        echo \"NODE_ENV=\${NODE_ENV}\" >> /app/.env

        # Start the application
        npm start
      "
