version: '3.8'

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: telegram-buddy
    restart: unless-stopped
    volumes:
      - db-data:/app/data/db
      - tmp-data:/app/tmp
    environment:
      TELEGRAM_TOKEN: ${TELEGRAM_TOKEN}
      AUTHORIZED_USERNAME: ${AUTHORIZED_USERNAME}
      DEEPSEEK_API_KEY: ${DEEPSEEK_API_KEY}
      NODE_ENV: production
    command: >
      sh -c "
        mkdir -p /app/data/db /app/tmp;

        echo \"# Generated .env file - DO NOT EDIT MANUALLY\" > /app/.env;
        echo \"TELEGRAM_TOKEN=${TELEGRAM_TOKEN}\" >> /app/.env;
        echo \"AUTHORIZED_USERNAME=${AUTHORIZED_USERNAME}\" >> /app/.env;
        echo \"DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}\" >> /app/.env;
        echo \"NODE_ENV=${NODE_ENV}\" >> /app/.env;

        npm start
      "

volumes:
  db-data:
  tmp-data:
